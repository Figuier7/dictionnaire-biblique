console.log("‚úÖ Interface unifi√©e du dictionnaire charg√©e (correction startsWith)");const sources=window.dictionarySources||{};let allData={},currentDict="BYM",currentLetter="A",currentPage=1;const itemsPerPage=30;function normalizeInput(t){return(t||"").normalize("NFD").replace(/[ÃÄ-ÕØ]/g,"").trim().toUpperCase()}function tolerantNormalize(t){let e=normalizeInput(t);return Object.entries({PH:"F",TH:"T",KH:"H",CH:"H",Q:"K",TS:"Z"}).forEach(([t,n])=>{e=e.replace(new RegExp(t,"g"),n)}),e}function initDictionaryApp(){const t=document.querySelectorAll(".dict-tab"),e=document.getElementById("alphabet-selector"),n=document.getElementById("word-list"),r=document.getElementById("dictionary-content"),i=document.createElement("input");i.placeholder="üîç Rechercher un mot...",i.id="dictionary-search",n.before(i);const a=document.createElement("div");function c(t){if(window.innerWidth<=640)return void(e.innerHTML="");const n="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");e.innerHTML="",n.forEach(n=>{const r=document.createElement("button");r.textContent=n,r.addEventListener("click",()=>{currentLetter=n,currentPage=1,o(t,n,currentPage)}),e.appendChild(r)})}function o(t,e,r=1){const i=normalizeInput(e),a=allData[t].filter(t=>normalizeInput(t.mot).startsWith(i)),c=Math.ceil(a.length/30),l=30*(r-1),s=a.slice(l,l+30).map(e=>`<a href="#${t}/${e.mot}">${e.mot}</a>`).join(""),d=c>1?`<div class='pagination'>${Array.from({length:c},(t,e)=>`<button class="page-btn" data-page="${e+1}">${e+1}</button>`).join("")}</div>`:"";n.innerHTML=s+d,n.style.display="block",document.querySelectorAll(".page-btn").forEach(t=>{t.addEventListener("click",()=>{currentPage=parseInt(t.dataset.page),o(currentDict,currentLetter,currentPage)})})}function l(){const t=decodeURIComponent(location.hash.slice(1));if(!t.includes("/"))return;const[e,i]=t.split("/");sources[e]&&function(t,e){const i=tolerantNormalize(e),a=Object.entries(allData).map(([t,e])=>{const n=e.find(t=>tolerantNormalize(t.mot)===i);return n?{dict:t,entry:n}:null}).filter(Boolean);if(0===a.length)return void(r.innerHTML="<p>Mot introuvable.</p>");n.style.display="none";const c=['<p><a href="#" id="back">‚Üê Retour √† la liste</a></p>'];a.forEach(({dict:t,entry:e})=>{const n="BYM"===t?"Dictionnaire biblique de la BYM":"Easton"===t?"Easton's Bible Dictionary":t,r=marked.parse(e.definition),i="undefined"!=typeof DOMPurify?DOMPurify.sanitize(r):r;c.push(`<h2>${e.mot} ‚Äî ${n}</h2>`,i)}),r.innerHTML=c.join("\n"),document.getElementById("back").onclick=t=>{t.preventDefault(),n.style.display="block",r.innerHTML=""}}(0,i)}function s(){const t=tolerantNormalize(this.value.trim());if(t.length<2)return;const e=Object.entries(allData).flatMap(([e,n])=>n.filter(e=>tolerantNormalize(e.mot).includes(t)).map(t=>({dict:e,mot:t.mot}))).slice(0,50);n.innerHTML=e.map(t=>`<a href="#${t.dict}/${t.mot}">${t.mot} <small>(${t.dict})</small></a>`).join(""),r.innerHTML="",n.style.display="block"}a.id="dictionary-message",i.insertAdjacentElement("afterend",a),t.forEach(e=>{e.addEventListener("click",()=>{t.forEach(t=>t.classList.remove("active")),e.classList.add("active"),currentDict=e.dataset.dict,currentPage=1,n.style.display="block",r.innerHTML="",i.value="",c(currentDict),o(currentDict,currentLetter,currentPage)})}),Promise.all(Object.entries(sources).map(async([t,e])=>{try{const n=await fetch(e);if(!n.ok)throw new Error(`HTTP ${n.status}`);const r=await n.json();allData[t]=Array.isArray(r)?r.map(t=>({mot:t.mot||t.term||"",definition:t.definition||""})):Object.entries(r).map(([t,e])=>({mot:t,definition:e}))}catch(e){console.error(`Failed to load dictionary ${t}:`,e);const n=document.createElement("p");n.textContent=`Impossible de charger le dictionnaire ${t}.`,a.appendChild(n)}})).then(()=>{if(0===Object.keys(allData).length){const t=document.createElement("p");return t.textContent="Aucun dictionnaire n'a pu √™tre charg√©.",void a.appendChild(t)}c(currentDict),o(currentDict,currentLetter,currentPage),l(),i.addEventListener("input",s),window.addEventListener("hashchange",l)})}document.addEventListener("DOMContentLoaded",initDictionaryApp);